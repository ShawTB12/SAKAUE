import datetime
from typing import Dict, Any

from .base import FortuneSystem
from utils.date_utils import get_lunar_date

class Shukuyo(FortuneSystem):
    """
    宿曜による性格診断システム
    """
    
    def __init__(self):
        """
        初期化メソッド
        """
        super().__init__("shukuyo_data.json")
    
    def diagnose(self, birth_date: datetime.date) -> Dict[str, Any]:
        """
        誕生日から宿曜による性格診断を行う
        
        Args:
            birth_date: 生年月日
            
        Returns:
            診断結果をDict形式で返す
        """
        # 宿曜を算出
        shukuyo_name = self._calculate_shukuyo(birth_date)
        
        # 本命宮を取得
        honmei_kyu = self._get_honmei_kyu(shukuyo_name)
        
        # 守護尊を取得
        shugo_son = self._get_shugo_son(shukuyo_name)
        
        # 性格特性を取得
        personality_traits = self.get_personality_traits(shukuyo_name)
        
        # 相性を取得
        compatibility = self.get_compatibility(shukuyo_name)
        
        # 結果を返す
        result = {
            "shukuyo": shukuyo_name,
            "honmei_kyu": honmei_kyu,
            "shugo_son": shugo_son,
            "personality_traits": personality_traits,
            "compatibility": compatibility
        }
        
        return result
    
    def _calculate_shukuyo(self, birth_date: datetime.date) -> str:
        """
        生年月日から宿曜を算出する
        
        Args:
            birth_date: 生年月日
            
        Returns:
            宿曜名
        """
        # 旧暦（太陰暦）の日付を取得
        lunar_date = get_lunar_date(birth_date)
        
        # 宿曜マップ（簡略化）
        # 実際の宿曜計算は旧暦をベースに複雑な計算を行いますが、
        # ここでは例として簡略化したマッピングを使用します
        shukuyo_map = {
            1: ["角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", 
                "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", 
                "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿"],
            2: ["井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", 
                "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", 
                "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿"],
            3: ["斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", 
                "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", 
                "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿"],
            4: ["奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", 
                "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", 
                "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿"],
            5: ["角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", 
                "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", 
                "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿"],
            6: ["井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", 
                "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", 
                "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿"],
            7: ["斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", 
                "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", 
                "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿"],
            8: ["奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", 
                "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", 
                "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿"],
            9: ["角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", 
                "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", 
                "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿"],
            10: ["井宿", "鬼宿", "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", 
                 "底宿", "房宿", "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", 
                 "危宿", "室宿", "壁宿", "奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿"],
            11: ["斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿", "奎宿", "婁宿", 
                 "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", "柳宿", "星宿", 
                 "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", "心宿", "尾宿", "箕宿"],
            12: ["奎宿", "婁宿", "胃宿", "昴宿", "畢宿", "觜宿", "参宿", "井宿", "鬼宿", 
                 "柳宿", "星宿", "張宿", "翼宿", "軫宿", "角宿", "亢宿", "底宿", "房宿", 
                 "心宿", "尾宿", "箕宿", "斗宿", "牛宿", "女宿", "虚宿", "危宿", "室宿", "壁宿"]
        }
        
        # 旧暦の日付から宿曜を算出
        month = lunar_date["month"]
        day = lunar_date["day"]
        
        # 日付が配列の範囲内に収まるように調整
        day_index = (day - 1) % 28
        
        # 宿曜を返す
        return shukuyo_map.get(month, shukuyo_map[1])[day_index]
    
    def _get_honmei_kyu(self, shukuyo_name: str) -> str:
        """
        宿曜から本命宮を取得する
        
        Args:
            shukuyo_name: 宿曜名
            
        Returns:
            本命宮
        """
        if "honmei_kyu" in self.data and shukuyo_name in self.data["honmei_kyu"]:
            return self.data["honmei_kyu"][shukuyo_name]
        
        # 該当がない場合のデフォルト値
        honmei_kyu_map = {
            "角宿": "東方木命", "亢宿": "東方木命", "底宿": "東方木命", 
            "房宿": "南方火命", "心宿": "南方火命", "尾宿": "南方火命", "箕宿": "南方火命", 
            "斗宿": "中央土命", "牛宿": "中央土命", "女宿": "中央土命", 
            "虚宿": "西方金命", "危宿": "西方金命", "室宿": "西方金命", "壁宿": "西方金命", 
            "奎宿": "北方水命", "婁宿": "北方水命", "胃宿": "北方水命", 
            "昴宿": "東方木命", "畢宿": "東方木命", "觜宿": "東方木命", "参宿": "東方木命", 
            "井宿": "南方火命", "鬼宿": "南方火命", "柳宿": "南方火命", 
            "星宿": "中央土命", "張宿": "中央土命", "翼宿": "中央土命", "軫宿": "中央土命"
        }
        
        return honmei_kyu_map.get(shukuyo_name, "不明")
    
    def _get_shugo_son(self, shukuyo_name: str) -> str:
        """
        宿曜から守護尊を取得する
        
        Args:
            shukuyo_name: 宿曜名
            
        Returns:
            守護尊
        """
        if "shugo_son" in self.data and shukuyo_name in self.data["shugo_son"]:
            return self.data["shugo_son"][shukuyo_name]
        
        # 該当がない場合のデフォルト値
        shugo_son_map = {
            "角宿": "不動明王", "亢宿": "釈迦如来", "底宿": "文殊菩薩", 
            "房宿": "普賢菩薩", "心宿": "観音菩薩", "尾宿": "勢至菩薩", "箕宿": "虚空蔵菩薩", 
            "斗宿": "地蔵菩薩", "牛宿": "弥勒菩薩", "女宿": "薬師如来", 
            "虚宿": "阿弥陀如来", "危宿": "如意輪観音", "室宿": "大日如来", "壁宿": "降三世明王", 
            "奎宿": "阿閦如来", "婁宿": "大日如来", "胃宿": "宝生如来", 
            "昴宿": "阿弥陀如来", "畢宿": "不空成就如来", "觜宿": "弥勒菩薩", "参宿": "虚空蔵菩薩", 
            "井宿": "文殊菩薩", "鬼宿": "普賢菩薩", "柳宿": "観音菩薩", 
            "星宿": "勢至菩薩", "張宿": "地蔵菩薩", "翼宿": "釈迦如来", "軫宿": "不動明王"
        }
        
        return shugo_son_map.get(shukuyo_name, "不明")


# シングルトンインスタンスを作成
_instance = None

def diagnose(birth_date: datetime.date) -> Dict[str, Any]:
    """
    宿曜による診断を行うファサードメソッド
    
    Args:
        birth_date: 生年月日
        
    Returns:
        診断結果をDict形式で返す
    """
    global _instance
    
    if _instance is None:
        _instance = Shukuyo()
    
    return _instance.diagnose(birth_date) 